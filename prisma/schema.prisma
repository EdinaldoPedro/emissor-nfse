generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Ou "sqlite" se estiver usando arquivo local dev.db
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum Role {
  MASTER
  ADMIN
  SUPORTE
  SUPORTE_TI
  CONTADOR
  COMUM
}

enum StatusNota {
  RASCUNHO
  PROCESSANDO
  AUTORIZADA
  ERRO
  CANCELADA
}

// --- USUÁRIO ---
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  senha     String
  nome      String
  role      Role     @default(COMUM)
  cpf       String?  @unique
  telefone  String?
  
  // --- PLANO ---
  plano            String?    @default("GRATUITO")
  planoCiclo       String     @default("MENSAL")
  planoStatus      String     @default("active")
  planoExpiresAt   DateTime?
  
  // --- PERFIL ---
  cargo            String?
  avatarUrl        String?
  
  // --- CONFIGURAÇÕES ---
  darkMode         Boolean   @default(false)
  idioma           String    @default("pt-BR")
  notificacoesEmail Boolean  @default(true)
  
  // --- METADATA ---
  ipOrigem         String?
  lastLoginAt      DateTime? 
  
  // --- RELAÇÕES ---
  empresaId String?  @unique
  empresa   Empresa? @relation("DonoEmpresa", fields: [empresaId], references: [id])
  
  clientes  UserCliente[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- EMPRESAS ---
model Empresa {
  id        String   @id @default(uuid())
  documento String   @unique
  
  email        String?
  razaoSocial  String
  nomeFantasia String?
  
  cep        String?
  logradouro String?
  numero     String?
  complemento String?
  bairro     String?
  cidade     String?
  uf         String?
  codigoIbge String?
  
  inscricaoMunicipal String?
  regimeTributario   String? @default("MEI")
  
  donoUser     User?         @relation("DonoEmpresa")
  vinculadoA   UserCliente[] 
  atividades   Cnae[]
  
  certificadoA1    String?
  senhaCertificado String?
  
  // Relações com Notas Fiscais
  notasEmitidas    NotaFiscal[] @relation("PrestadorNota")
  notasRecebidas   NotaFiscal[] @relation("TomadorNota")
  
  // Relações com Vendas (Ciclo de Negócio)
  vendasRealizadas Venda[]      @relation("VendaPrestador")
  vendasCompradas  Venda[]      @relation("VendaTomador")

  logs             SystemLog[]
  
  updatedAt    DateTime @updatedAt
  lastApiCheck DateTime?
}

// --- VENDAS (A Transação Comercial) ---
model Venda {
  id              String   @id @default(uuid())
  
  // Quem vendeu (Prestador)
  empresaId       String
  empresa         Empresa  @relation("VendaPrestador", fields: [empresaId], references: [id])
  
  // Quem comprou (Tomador)
  clienteId       String
  cliente         Empresa  @relation("VendaTomador", fields: [clienteId], references: [id])
  
  valor           Decimal  @db.Decimal(10, 2)
  descricao       String
  
  // Status da Venda (independente da nota)
  status          String   @default("PENDENTE") // PENDENTE, CONCLUIDA, ERRO_EMISSAO, CANCELADA
  
  // Histórico dessa venda (Várias notas podem ser geradas para 1 venda se houver erro/correção)
  notas           NotaFiscal[]
  logs            SystemLog[]  // Logs específicos desta venda
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --- RELAÇÃO USER <-> CLIENTE ---
model UserCliente {
  id        String @id @default(uuid())
  
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  empresaId String
  empresa   Empresa @relation(fields: [empresaId], references: [id])
  
  apelido   String?
  createdAt DateTime @default(now())

  @@unique([userId, empresaId])
}

// --- CNAES DA EMPRESA ---
model Cnae {
  id          String @id @default(uuid())
  codigo      String 
  descricao   String 
  principal   Boolean @default(false)
  
  empresaId   String
  empresa     Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

// --- NOTAS FISCAIS ---
model NotaFiscal {
  id              String   @id @default(uuid())
  
  // Vínculo opcional com a Venda (para suportar notas legadas ou avulsas)
  vendaId         String?
  venda           Venda?   @relation(fields: [vendaId], references: [id])

  numero          Int?
  valor           Decimal  @db.Decimal(10, 2)
  descricao       String
  
  prestadorCnpj   String
  tomadorCnpj     String
  
  status          StatusNota @default(RASCUNHO)
  
  xmlBase64       String? // @db.Text (se usar Postgres, descomente)
  pdfBase64       String? // @db.Text
  
  chaveAcesso     String?
  protocolo       String?
  
  // Quem emitiu
  empresaId       String
  empresa         Empresa @relation("PrestadorNota", fields: [empresaId], references: [id])

  // Quem recebeu
  clienteId       String
  cliente         Empresa @relation("TomadorNota", fields: [clienteId], references: [id])

  cnae            String?
  codigoServico   String?
  
  dataEmissao     DateTime?
  createdAt       DateTime @default(now())
}

// --- CONFIGURAÇÕES GLOBAIS ---
model ConfiguracaoSistema {
  id             String @id @default("config")
  modeloDpsJson  String?
  versaoApi      String @default("1.00")
  ambiente       String @default("HOMOLOGACAO")
}

model GlobalCnae {
  id                        String   @id @default(uuid())
  codigo                    String   @unique
  descricao                 String
  
  itemLc                    String?
  codigoTributacaoNacional  String?
  
  aliquotaPadrao            Decimal? @db.Decimal(5,2)

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model TributacaoMunicipal {
  id                        String   @id @default(uuid())
  cnae                      String 
  codigoIbge                String 
  codigoTributacaoMunicipal String 
  descricaoServicoMunicipal String?

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([cnae, codigoIbge, codigoTributacaoMunicipal])
}

model Plan {
  id            String   @id @default(uuid())
  name          String   
  slug          String   @unique
  description   String?
  priceMonthly  Decimal  @db.Decimal(10, 2)
  priceYearly   Decimal  @db.Decimal(10, 2)
  features      String   
  active        Boolean  @default(true)
  recommended   Boolean  @default(false)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model SystemLog {
  id        String   @id @default(uuid())
  level     String
  action    String
  message   String
  details   String?
  
  empresaId String?
  empresa   Empresa? @relation(fields: [empresaId], references: [id])
  
  // Log vinculado a uma venda específica (Novo)
  vendaId   String?
  venda     Venda?   @relation(fields: [vendaId], references: [id])
  
  createdAt DateTime @default(now())
}