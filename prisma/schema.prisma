// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// --- USUÁRIO (Dono do SaaS) ---
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  senha     String
  nome      String   
  tipo      String   @default("CLIENTE")
  
  // Dados Pessoais
  cpf             String?
  telefone        String?
  plano           String?  @default("GRATUITO")
  
  // Dados da Empresa (PJ)
  documento       String? 
  razaoSocial     String?
  nomeFantasia    String?
  inscricaoMunicipal String?
  regimeTributario String? @default("MEI")
  
  // Endereço
  cep             String?
  logradouro      String?
  numero          String?
  complemento     String?
  bairro          String?
  cidade          String?
  uf              String?
  codigoIbge      String?

  // Certificado
  certificadoA1   String?
  senhaCertificado String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos com DELETE CASCADE (Se apagar o User, apaga tudo dele)
  clientes      Cliente[]    @relation(name: "UserClientes")
  notasFiscais  NotaFiscal[] @relation(name: "UserNotas")
  atividades    Cnae[]
}

// --- TABELA AUXILIAR DE CNAES ---
model Cnae {
  id          String @id @default(uuid())
  codigo      String 
  descricao   String 
  principal   Boolean @default(false)
  
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- CLIENTES (Tomadores) ---
model Cliente {
  id        String   @id @default(uuid())
  nome      String
  email     String?
  telefone  String?
  
  // Dados Fiscais
  documento String   
  inscricaoMunicipal String?
  
  // Endereço
  cep             String?
  logradouro      String?
  numero          String?
  complemento     String?
  bairro          String?
  cidade          String?
  uf              String?
  codigoIbge      String?

  userId    String
  user      User     @relation(name: "UserClientes", fields: [userId], references: [id], onDelete: Cascade)
  
  // Relacionamento inverso
  notas     NotaFiscal[]
  
  createdAt DateTime @default(now())
}

// --- NOTAS FISCAIS ---
model NotaFiscal {
  id              String   @id @default(uuid())
  numero          Int?
  valor           Decimal
  descricao       String
  
  // Dados Específicos
  codigoServico   String?
  cnae            String?
  
  status          String   @default("RASCUNHO")
  
  // Retornos da API
  chaveAcesso     String?
  linkPdf         String?
  xmlAutorizado   String?
  
  userId          String
  user            User     @relation(name: "UserNotas", fields: [userId], references: [id], onDelete: Cascade)
  
  clienteId       String
  // AQUI ESTÁ A CORREÇÃO MÁGICA: onDelete: Cascade
  cliente         Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  dataEmissao     DateTime?
  createdAt       DateTime @default(now())
}