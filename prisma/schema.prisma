generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // <--- MUDANÇA PRINCIPAL
  url      = env("DATABASE_URL")
}

// --- ENUMS (Agora funcionam!) ---
enum Role {
  ADMIN
  COMUM
  SUPORTE
}

enum StatusNota {
  RASCUNHO
  PROCESSANDO
  AUTORIZADA
  ERRO
  CANCELADA
}

// --- USUÁRIO ---
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  senha     String
  nome      String
  role      Role     @default(COMUM)
  cpf       String   @unique
  telefone  String?
  
  // --- PLANO DETALHADO ---
  plano            String?   @default("GRATUITO") // Tipo (Premium, Basic, etc)
  planoStatus      String    @default("active")   // active, inactive, cancelled
  planoExpiresAt   DateTime?                      // Data de vencimento

  // --- PERFIL ---
  cargo            String?
  avatarUrl        String?
  // Empresa já está vinculada via relação 'empresa'

  // --- CONFIGURAÇÕES ---
  darkMode         Boolean   @default(false)
  idioma           String    @default("pt-BR")
  notificacoesEmail Boolean  @default(true)

  // --- METADATA ---
  ipOrigem         String?
  lastLoginAt      DateTime? 
  
  // ... (restante das relações: empresaId, clientes, notas, etc)
  empresaId String?  @unique
  empresa   Empresa? @relation("DonoEmpresa", fields: [empresaId], references: [id])
  clientes  UserCliente[]
  certificadoA1    String? 
  senhaCertificado String?
  notasEmitidas NotaFiscal[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- EMPRESAS ---
model Empresa {
  id        String   @id @default(uuid())
  documento String   @unique
  
  razaoSocial  String
  nomeFantasia String?
  
  cep          String?
  logradouro   String?
  numero       String?
  complemento  String?
  bairro       String?
  cidade       String?
  uf           String?
  codigoIbge   String?

  inscricaoMunicipal String?
  regimeTributario   String? @default("MEI")
  
  donoUser     User?         @relation("DonoEmpresa")
  vinculadoA   UserCliente[] 
  atividades   Cnae[]

  updatedAt    DateTime @updatedAt
  lastApiCheck DateTime? 
}

// --- RELAÇÃO USER <-> CLIENTE ---
model UserCliente {
  id        String @id @default(uuid())
  
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  empresaId String
  empresa   Empresa @relation(fields: [empresaId], references: [id])

  apelido   String? 
  createdAt DateTime @default(now())

  @@unique([userId, empresaId])
}

model Cnae {
  id          String @id @default(uuid())
  codigo      String 
  descricao   String 
  principal   Boolean @default(false)
  
  empresaId   String
  empresa     Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

// --- NOTAS FISCAIS ---
model NotaFiscal {
  id              String   @id @default(uuid())
  numero          Int?
  valor           Decimal  @db.Decimal(10, 2) // Postgres exige precisão para Decimal
  descricao       String
  
  prestadorCnpj   String
  tomadorCnpj     String
  
  status          StatusNota @default(RASCUNHO)
  
  xmlBase64       String?  @db.Text // @db.Text permite strings gigantes (base64)
  pdfBase64       String?  @db.Text
  
  chaveAcesso     String?
  protocolo       String?
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  dataEmissao     DateTime?
  createdAt       DateTime @default(now())
}

// --- CONFIG ---
model ConfiguracaoSistema {
  id             String @id @default("config")
  modeloDpsJson  String?
  versaoApi      String @default("1.00")
  ambiente       String @default("HOMOLOGACAO")
}