// Configuração do Banco
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Ou "sqlite"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum Role {
  MASTER
  ADMIN
  SUPORTE
  SUPORTE_TI
  CONTADOR
  COMUM
}

enum StatusNota {
  RASCUNHO
  PROCESSANDO
  AUTORIZADA
  ERRO
  CANCELADA
}

// --- USUÁRIO ---
model User {
  id                String   @id @default(uuid())
  email             String   @unique
  senha             String
  nome              String
  role              Role     @default(COMUM)
  cpf               String?  @unique
  telefone          String?
  
  plano             String?    @default("GRATUITO")
  planoCiclo        String     @default("MENSAL")
  planoStatus       String     @default("active")
  planoExpiresAt    DateTime?
  cargo             String?
  avatarUrl         String?

  // === RECUPERAÇÃO DE SENHA ===
  resetToken        String?    @unique
  resetExpires      DateTime?
  
  darkMode          Boolean    @default(false)
  idioma            String     @default("pt-BR")
  notificacoesEmail Boolean    @default(true)
  
  ipOrigem          String?
  lastLoginAt       DateTime? 
  
  empresaId String?  @unique
  empresa   Empresa? @relation("DonoEmpresa", fields: [empresaId], references: [id])
  
  // Relacionamento antigo (User -> Empresa) mantido para permissões
  clientes  UserCliente[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ticketsCriados    Ticket[] @relation("SolicitanteTicket")
  ticketsAtendidos  Ticket[] @relation("AtendenteTicket")
  mensagensTicket   TicketMensagem[]

  empresasContabeis ContadorVinculo[] @relation("ContadorUser")

  // === VALIDAÇÃO DE TROCA DE E-MAIL ===
  tempEmail         String?
  verificationCode  String?    
  verificationExpires DateTime? 

  limiteEmpresas    Int      @default(5)

  // Controle do Tutorial
  tutorialStep      Int       @default(0)

  // Relacionamento com Histórico
  historicoPlanos   PlanHistory[]

  // === CONTROLE DE CONSUMO ===
  creditosPlano       Int       @default(0) 
  creditosExtras      Int       @default(0) 
  dataRenovacaoCiclo DateTime?

  // Relacionamento com Pedidos
  pedidos             Pedido[]
}

// --- EMPRESAS (Quem emite a nota - PRESTADOR) ---
model Empresa {
  id        String   @id @default(uuid())
  documento String   @unique
  ambiente  String   @default("HOMOLOGACAO")
  
  cadastroCompleto Boolean @default(false)

  // Controle de Emissão (DPS)
  serieDPS    String   @default("900")
  ultimoDPS   Int      @default(0)

  email        String?
  razaoSocial  String
  nomeFantasia String?
  cep          String?
  logradouro   String?
  numero       String?
  complemento  String?
  bairro       String?
  cidade       String?
  uf           String?
  codigoIbge   String?

  aliquotaPadrao            Decimal? @default(0.00) @db.Decimal(5, 2) 
  issRetidoPadrao         Boolean  @default(false)
  tipoTributacaoPadrao    String?  @default("1") // 1=Exigível
  regimeEspecialTributacao String? @default("0") // 0=Nenhum
  
  inscricaoMunicipal String?
  regimeTributario   String? @default("MEI")
  
  // Relações
  donoUser      User?         @relation("DonoEmpresa")
  vinculadoA    UserCliente[] 
  atividades    Cnae[]
  
  // === MUDANÇA: CATÁLOGO GLOBAL ===
  // Em vez de "possuir" clientes, a empresa possui "vínculos" com o Catálogo
  minhaCarteira VinculoCarteira[] 

  // Certificado
  certificadoA1        String?
  senhaCertificado     String?    
  certificadoVencimento DateTime? 
  
  // Notas Fiscais (Apenas como EMISSOR)
  notasEmitidas    NotaFiscal[] @relation("PrestadorNota")
  
  // Vendas (Apenas como EMISSOR)
  vendasRealizadas Venda[]      @relation("VendaPrestador")
  
  logs              SystemLog[]
  
  updatedAt    DateTime @updatedAt
  lastApiCheck DateTime?

  contadoresLink    ContadorVinculo[] @relation("EmpresaContabil")
}

// --- CLIENTE (Tomador do Serviço - CATÁLOGO GLOBAL) ---
model Cliente {
  id            String   @id @default(uuid())
  
  // === MUDANÇA: INDEPENDÊNCIA ===
  // Removemos empresaId. O Cliente agora é "do mundo", não de uma empresa só.
  
  // Discriminador e Dados Principais
  tipo          String   @default("PJ") // "PJ", "PF", "EXT"
  
  // Documento agora é ÚNICO GLOBALMENTE (ex: Se a Google já existe, usa o mesmo ID)
  documento     String?  @unique 
  
  nome          String   // Razão Social ou Nome Completo (Dado Oficial)
  nomeFantasia  String?  // Dado Oficial
  
  // Contato Público (Oficial)
  email         String?
  telefone      String?

  // Fiscal
  inscricaoMunicipal String?
  inscricaoEstadual  String?

  // Endereço Oficial
  cep           String?
  logradouro    String?
  numero        String?
  complemento   String?
  bairro        String?
  cidade        String?
  uf            String?
  pais          String   @default("Brasil") 
  codigoIbge    String?

  // Relacionamentos Inversos
  notas         NotaFiscal[] // Histórico global de notas recebidas
  vendas        Venda[]      // Histórico global de compras
  
  // Quem tem esse cliente na agenda?
  vinculos      VinculoCarteira[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// --- NOVO: VÍNCULO (A "Agenda" de cada Empresa) ---
model VinculoCarteira {
  id            String   @id @default(uuid())
  
  // Quem cadastrou/vinculou?
  empresaId     String
  empresa       Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  
  // Quem é o cliente?
  clienteId     String
  cliente       Cliente  @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  
  // Dados PRIVADOS (Só essa empresa vê)
  apelido       String?  // Ex: "Google Marketing"
  tags          String?  // Ex: "Vip, Atrasado"
  observacoes   String?
  emailFinanceiro String? // E-mail específico para enviar nota DESSA empresa
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Garante que uma empresa não adicione o mesmo cliente 2x na agenda
  @@unique([empresaId, clienteId])
}

// --- VENDAS ---
model Venda {
  id              String   @id @default(uuid())
  
  empresaId       String
  empresa         Empresa  @relation("VendaPrestador", fields: [empresaId], references: [id])
  
  clienteId       String
  cliente         Cliente  @relation(fields: [clienteId], references: [id])
  
  valor           Decimal  @db.Decimal(10, 2)
  descricao       String
  
  status          String   @default("PENDENTE") 
  
  notas           NotaFiscal[]
  logs            SystemLog[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model UserCliente {
  id        String @id @default(uuid())
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  empresaId String
  empresa   Empresa @relation(fields: [empresaId], references: [id])
  apelido   String?
  createdAt DateTime @default(now())

  @@unique([userId, empresaId])
}

model Cnae {
  id           String @id @default(uuid())
  codigo       String 
  descricao    String 
  principal    Boolean @default(false)
  codigoNbs         String?
  temRetencaoInss   Boolean  @default(false)
  empresaId    String
  empresa      Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

// --- NOTAS FISCAIS ---
model NotaFiscal {
  id              String   @id @default(uuid())
  
  vendaId         String?
  venda           Venda?   @relation(fields: [vendaId], references: [id])

  numero          Int?
  valor           Decimal  @db.Decimal(10, 2)
  descricao       String
  
  prestadorCnpj   String
  tomadorCnpj     String
  
  status          StatusNota @default(RASCUNHO)
  
  xmlBase64       String?
  pdfBase64       String? 
  
  chaveAcesso     String?
  protocolo       String?
  
  empresaId       String
  empresa         Empresa @relation("PrestadorNota", fields: [empresaId], references: [id])

  // Continua apontando para o Cliente Global (Historicamente correto)
  clienteId       String
  cliente         Cliente @relation(fields: [clienteId], references: [id])

  cnae            String?
  codigoServico   String?
  
  dataEmissao     DateTime?
  createdAt       DateTime @default(now())
}

model ConfiguracaoSistema {
  id             String @id @default("config")
  modeloDpsJson  String?
  versaoApi      String @default("1.00")
  ambiente       String @default("HOMOLOGACAO")
  
  smtpHost       String?
  smtpPort       Int?    @default(587)
  smtpUser       String?
  smtpPass       String?
  smtpSecure     Boolean @default(false)
  emailRemetente String?
}

model GlobalCnae {
  id                        String   @id @default(uuid())
  codigo                    String   @unique
  descricao                 String
  itemLc                    String?
  codigoTributacaoNacional  String?
  aliquotaPadrao            Decimal? @db.Decimal(5,2)
  codigoNbs                 String?
  temRetencaoInss           Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

model TributacaoMunicipal {
  id                        String   @id @default(uuid())
  cnae                      String 
  codigoIbge                String 
  codigoTributacaoMunicipal String 
  descricaoServicoMunicipal String?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  @@unique([cnae, codigoIbge, codigoTributacaoMunicipal])
}

model Plan {
  id             String   @id @default(uuid())
  name           String   
  slug           String   @unique
  description    String?
  priceMonthly   Decimal  @db.Decimal(10, 2)
  priceYearly    Decimal  @db.Decimal(10, 2)
  features       String   
  active         Boolean  @default(true)
  recommended    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  maxNotasMensal    Int       @default(0) 
  diasTeste         Int       @default(0) 
  privado           Boolean   @default(false) 

  historico         PlanHistory[]
}

model PlanHistory {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  
  planId      String
  plan        Plan      @relation(fields: [planId], references: [id])
  
  dataInicio  DateTime  @default(now())
  dataFim     DateTime?
  status      String    @default("ATIVO") 
  
  notasEmitidas Int      @default(0) 
  
  createdAt   DateTime  @default(now())
}

model SystemLog {
  id        String   @id @default(uuid())
  level     String
  action    String
  message   String
  details   String?
  empresaId String?
  empresa   Empresa? @relation(fields: [empresaId], references: [id])
  vendaId   String?
  venda     Venda?   @relation(fields: [vendaId], references: [id])
  createdAt DateTime @default(now())
}

model Ticket {
  id             String   @id @default(uuid())
  protocolo      Int      @default(autoincrement())
  assunto        String
  categoria      String?
  prioridade     String   @default("MEDIA")
  descricao      String
  status         String   @default("ABERTO")
  clientUnread   Boolean  @default(false)

  anexoBase64    String?
  anexoNome      String?

  catalogId      String?
  catalogItem    TicketCatalog? @relation(fields: [catalogId], references: [id])
  solicitanteId  String
  solicitante    User      @relation("SolicitanteTicket", fields: [solicitanteId], references: [id])
  atendenteId    String?
  atendente      User?     @relation("AtendenteTicket", fields: [atendenteId], references: [id])
  mensagens      TicketMensagem[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model TicketMensagem {
  id        String   @id @default(uuid())
  mensagem  String   
  anexos    String?
  interno   Boolean  @default(false)

  anexoBase64 String?
  anexoNome   String?
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  usuarioId String
  usuario   User     @relation(fields: [usuarioId], references: [id])
  
  createdAt DateTime @default(now())
}

model ContadorVinculo {
  id        String   @id @default(uuid())
  status    String   @default("PENDENTE") 
  
  contadorId String
  contador   User      @relation("ContadorUser", fields: [contadorId], references: [id])
  
  empresaId  String
  empresa    Empresa   @relation("EmpresaContabil", fields: [empresaId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([contadorId, empresaId])
}

model TicketCatalog {
  id          String   @id @default(uuid())
  titulo      String   
  prioridade  String   @default("MEDIA")
  instrucoes  String?
  ativo       Boolean  @default(true)
  
  tickets     Ticket[] 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model MunicipioHomologado {
  id        String   @id @default(uuid())
  uf        String
  nome      String
  status    Int      @default(2) // 0=Verde, 1=Azul, 2=Ambar, 3=Cinza
  regime    String   @default("SN") // "SN" (Simples) ou "LP" (Lucro Presumido)
  
  createdAt DateTime @default(now())
}

model Pedido {
  id              String   @id @default(uuid())
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  planoSlug       String   
  ciclo           String   
  notasAdicionais Int      @default(0) 
  
  valorPlano      Decimal  @db.Decimal(10, 2)
  valorAdicionais Decimal  @db.Decimal(10, 2)
  valorTotal      Decimal  @db.Decimal(10, 2)
  
  status          String   @default("PENDENTE") 
  formaPagamento  String?
  gatewayId       String?  
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}