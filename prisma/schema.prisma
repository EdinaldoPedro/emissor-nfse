generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---
enum Role {
  ADMIN
  COMUM
  SUPORTE
}

enum StatusNota {
  RASCUNHO
  PROCESSANDO
  AUTORIZADA
  ERRO
  CANCELADA
}

// --- USUÁRIO ---
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  senha     String
  nome      String
  role      Role     @default(COMUM)
  cpf       String?  @unique // Deixei opcional (?) pois as vezes falha se não tiver
  telefone  String?
  
  // --- PLANO ---
  plano            String?    @default("GRATUITO")
  planoStatus      String     @default("active")
  planoExpiresAt   DateTime?

  // --- PERFIL ---
  cargo            String?
  avatarUrl        String?

  // --- CONFIGURAÇÕES ---
  darkMode         Boolean   @default(false)
  idioma           String    @default("pt-BR")
  notificacoesEmail Boolean  @default(true)

  // --- METADATA ---
  ipOrigem         String?
  lastLoginAt      DateTime? 
  
  // --- RELAÇÕES ---
  empresaId String?  @unique
  empresa   Empresa? @relation("DonoEmpresa", fields: [empresaId], references: [id])
  
  clientes  UserCliente[]
  // (NotaFiscal removida daqui, correto!)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- EMPRESAS ---
model Empresa {
  id        String   @id @default(uuid())
  documento String   @unique
  
  email     String?
  razaoSocial  String
  nomeFantasia String?
  
  cep        String?
  logradouro String?
  numero     String?
  complemento String?
  bairro     String?
  cidade     String?
  uf         String?
  codigoIbge String?

  inscricaoMunicipal String?
  regimeTributario   String? @default("MEI")
  
  donoUser     User?         @relation("DonoEmpresa")
  vinculadoA   UserCliente[] 
  atividades   Cnae[]

  // --- CAMPOS MOVIDOS DO USER PARA CÁ (CORRETO) ---
  certificadoA1    String? 
  senhaCertificado String?
  notasEmitidas    NotaFiscal[] // Agora a empresa tem as notas

  updatedAt    DateTime @updatedAt
  lastApiCheck DateTime? 
}

// --- RELAÇÃO USER <-> CLIENTE ---
model UserCliente {
  id        String @id @default(uuid())
  
  userId    String
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  empresaId String
  empresa   Empresa @relation(fields: [empresaId], references: [id])

  apelido   String? 
  createdAt DateTime @default(now())

  @@unique([userId, empresaId])
}

model Cnae {
  id          String @id @default(uuid())
  codigo      String 
  descricao   String 
  principal   Boolean @default(false)
  
  empresaId   String
  empresa     Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
}

// --- NOTAS FISCAIS ---
model NotaFiscal {
  id              String   @id @default(uuid())
  numero          Int?
  valor           Decimal  @db.Decimal(10, 2)
  descricao       String
  
  prestadorCnpj   String
  tomadorCnpj     String
  
  status          StatusNota @default(RASCUNHO)
  
  xmlBase64       String?  @db.Text
  pdfBase64       String?  @db.Text
  
  chaveAcesso     String?
  protocolo       String?
  
  // === AQUI ESTAVA O ERRO, CORRIGIDO: ===
  
  // 1. Vinculamos à EMPRESA (quem emite)
  empresaId       String
  empresa         Empresa @relation(fields: [empresaId], references: [id])

  // 2. Mantemos apenas o ID do cliente tomador
  clienteId       String
  
  // 3. Opcional: Se quiser saber QUAL usuário logado apertou o botão (auditoria)
  // criadoPorId     String? 
  
  // Campos extras usados na API
  cnae            String?
  codigoServico   String?

  dataEmissao     DateTime?
  createdAt       DateTime @default(now())
}

// --- CONFIG ---
model ConfiguracaoSistema {
  id             String @id @default("config")
  modeloDpsJson  String?
  versaoApi      String @default("1.00")
  ambiente       String @default("HOMOLOGACAO")
}

model GlobalCnae {
  id                        String   @id @default(uuid()) // <--- Corrigido (espaço)
  codigo                    String   @unique // Ex: 6202-3/00
  descricao                 String
  
  // Campos editáveis pelo Admin
  itemLc                    String?  // <--- Corrigido (espaço)
  codigoTributacaoNacional  String? // Código padrão nacional (Ex: 01.07.01)
  
  aliquotaPadrao            Decimal? @db.Decimal(5,2) // Opcional: Alíquota sugerida

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
}

// 2. Exceções Municipais (Substituto Tributário / De-Para)
model TributacaoMunicipal {
  id                        String   @id @default(uuid())
  
  cnae                      String // O CNAE que dispara a regra
  codigoIbge                String // O Município onde a regra se aplica
  
  // A informação crucial para a NFS-e naquele município
  codigoTributacaoMunicipal String 
  
  descricaoServicoMunicipal String? // Algumas prefeituras exigem descrição específica

  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  @@unique([cnae, codigoIbge, codigoTributacaoMunicipal])
}